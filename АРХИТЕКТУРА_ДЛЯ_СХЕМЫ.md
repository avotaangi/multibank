# Техническая архитектура MultiBank - описание для создания схемы

## Общая структура архитектуры

### Уровни (слои) системы (сверху вниз):

1. **Уровень представления (Presentation Layer)**
2. **Уровень приложения (Application Layer)**
3. **Уровень бизнес-логики (Business Logic Layer)**
4. **Уровень данных (Data Layer)**
5. **Внешние интеграции (External Integrations)**

---

## 1. УРОВЕНЬ ПРЕДСТАВЛЕНИЯ (Presentation Layer)

### Прототип:
- **Контейнер**: Telegram Mini App (Telegram WebView)
- **Компонент**: React Frontend Application
  - Технологии: React 18.2, Vite 5.0.0
  - Маршрутизация: React Router v6
  - Управление состоянием: Zustand 4.5.7
  - Работа с API: React Query 3.39.3, Axios 1.6.2
  - Стилизация: Tailwind CSS 3.3.6
  - Иконки: Lucide React
  - Формы: React Hook Form

### Финальное решение:
- **Контейнер**: Приложение банка (iOS/Android)
  - iOS: WKWebView
  - Android: WebView
- **Компонент**: React Frontend Application (тот же, что в прототипе)
- **Дополнительно**: Нативные мосты для взаимодействия с приложением банка

### Структура Frontend:
```
Frontend Application
├── Pages (Страницы)
│   ├── DashboardPage
│   ├── MyCardsPage
│   ├── TransferPage
│   ├── PaymentsPage
│   └── ... (другие страницы)
├── Components (Компоненты)
│   ├── Layout
│   ├── BankCardStack
│   ├── BottomNavigation
│   └── ... (другие компоненты)
├── Stores (Zustand)
│   ├── authStore
│   ├── balanceStore
│   └── transfersStore
├── Services (API)
│   └── api.js (Axios instance)
└── Hooks
    ├── useTelegramUser (прототип)
    └── usePageInfo
```

**Связи:**
- Frontend → Backend API Gateway (HTTPS, REST API, порт 3001)
- Frontend → Telegram WebApp API (только прототип)
- Frontend → Нативные мосты приложения банка (только финальное решение)

---

## 2. УРОВЕНЬ ПРИЛОЖЕНИЯ (Application Layer)

### Backend API Gateway

**Компонент**: API Gateway Server
- **Вариант 1**: Node.js/Express (порт 3001)
  - Express 4.18.2
  - Middleware: JWT, CORS, Helmet, express-rate-limit, express-validator
  - Логирование: Morgan
- **Вариант 2**: FastAPI (Python)
  - FastAPI
  - Middleware: JWT (python-jose), Pydantic для валидации
  - HTTP клиент: httpx

**Функции API Gateway:**
- Аутентификация и авторизация (JWT токены)
- Валидация входящих запросов
- Rate limiting (100 запросов/15 мин на IP)
- Проксирование запросов к внешним API
- Обработка ошибок
- Логирование

**API Endpoints:**
```
/api/auth/*          - Аутентификация
/api/users/*         - Пользователи
/api/accounts/*      - Счета
/api/transactions/*  - Транзакции
/api/payments/*     - Платежи
/api/consents/*      - Согласия
/api/products/*      - Продукты
/api/rewards/*       - Бонусы
/api/leads/*         - Лиды
/api/credit-products/* - Кредитные продукты
/api/card-management/* - Управление картами
/api/universal-payments/* - Универсальные платежи
/api/mobile-payments/* - Мобильные платежи
```

**Связи:**
- API Gateway → MongoDB (через Mongoose/Motor)
- API Gateway → BankingClient Service
- API Gateway → External Banking APIs (VBank, ABank, SBank)

---

## 3. УРОВЕНЬ БИЗНЕС-ЛОГИКИ (Business Logic Layer)

### BankingClient Service

**Компонент**: Единый сервис для работы с банками
- **Функции:**
  - Управление токенами доступа для каждого банка
  - Кеширование токенов
  - Унифицированный интерфейс для всех банков
  - Обработка ошибок
  - Автоматическое обновление токенов

**Банки:**
- VBank: https://vbank.open.bankingapi.ru
- ABank: https://abank.open.bankingapi.ru
- SBank: https://sbank.open.bankingapi.ru

**Связи:**
- BankingClient → VBank Open Banking API
- BankingClient → ABank Open Banking API
- BankingClient → SBank Open Banking API

### Authentication Service

**Прототип:**
- Верификация Telegram WebApp (initData)
- Генерация JWT токенов
- Хеширование PIN-кодов (bcryptjs, 12 раундов)

**Финальное решение:**
- OAuth2/OpenID Connect
- SSO (единый вход)
- Биометрия (Face ID, Touch ID, Android Biometric)
- Интеграция с системой аутентификации банка

---

## 4. УРОВЕНЬ ДАННЫХ (Data Layer)

### База данных: MongoDB

**Компонент**: MongoDB Database (NoSQL)

**Коллекции:**

1. **users**
   - Поля: telegramId (прототип) / bankUserId (финальное решение), username, firstName, lastName, email, phone, isActive, isVerified, lastLogin, preferences, security (twoFactorEnabled, pinHash)
   - Индексы: telegramId/bankUserId, email, createdAt

2. **accounts**
   - Поля: userId, accountNumber, accountType, currency, balance, availableBalance, creditLimit, interestRate, status, isDefault, metadata
   - Индексы: userId+accountType, accountNumber, status

3. **transactions**
   - Поля: transactionId, fromAccount, toAccount, userId, type, category, amount, currency, exchangeRate, description, status, reference, metadata, fees, processedAt
   - Индексы: userId+createdAt, fromAccount+createdAt, toAccount+createdAt, type+status, transactionId

**ODM:**
- Node.js: Mongoose 8.0.3
- FastAPI: Motor (асинхронный драйвер)

**Связи:**
- Backend API Gateway → MongoDB (чтение/запись)

---

## 5. ВНЕШНИЕ ИНТЕГРАЦИИ (External Integrations)

### Прототип:

1. **Telegram Bot API**
   - Доступ к Mini App
   - Управление ботом

2. **Telegram WebApp API**
   - Инициализация приложения
   - Получение данных пользователя (initData)
   - Взаимодействие с Telegram

3. **Open Banking APIs**
   - VBank Open Banking API
   - ABank Open Banking API
   - SBank Open Banking API

### Финальное решение:

1. **Open Banking APIs** (без изменений)
   - VBank Open Banking API
   - ABank Open Banking API
   - SBank Open Banking API

2. **Внутренние API банка** (новое)
   - Интеграция через нативные мосты
   - Специфические API банка

3. **Система аутентификации банка** (новое)
   - OAuth2/OpenID Connect Provider
   - SSO система
   - Биометрические API

---

## ПОТОКИ ДАННЫХ

### Типичный запрос (прототип):

```
1. Пользователь → Telegram Mini App (WebView)
   ↓
2. React Frontend → API Gateway (/api/*)
   ↓
3. API Gateway → Middleware (JWT проверка, валидация)
   ↓
4. API Gateway → BankingClient Service
   ↓
5. BankingClient → Open Banking API (VBank/ABank/SBank)
   ↓
6. Open Banking API → BankingClient (ответ)
   ↓
7. BankingClient → API Gateway
   ↓
8. API Gateway → MongoDB (сохранение данных, если нужно)
   ↓
9. API Gateway → React Frontend (ответ)
   ↓
10. React Frontend → React Query (кеширование)
   ↓
11. React Frontend → Zustand Store (обновление состояния)
   ↓
12. UI обновляется с новыми данными
```

### Аутентификация (прототип):

```
1. Пользователь открывает приложение в Telegram
   ↓
2. Telegram WebApp → initData
   ↓
3. React Frontend → API Gateway (/api/auth/telegram)
   ↓
4. API Gateway → Верификация initData
   ↓
5. API Gateway → MongoDB (создание/обновление пользователя)
   ↓
6. API Gateway → Генерация JWT токена
   ↓
7. API Gateway → React Frontend (JWT токен)
   ↓
8. React Frontend → Сохранение токена в памяти
   ↓
9. Все последующие запросы с Authorization: Bearer {token}
```

### Аутентификация (финальное решение):

```
1. Пользователь открывает вкладку в приложении банка
   ↓
2. Приложение банка → OAuth2/OpenID Connect Provider
   ↓
3. Биометрическая аутентификация (Face ID/Touch ID)
   ↓
4. OAuth Provider → Access Token
   ↓
5. Приложение банка → React Frontend (через нативный мост)
   ↓
6. React Frontend → API Gateway (/api/auth/bank)
   ↓
7. API Gateway → Верификация токена от банка
   ↓
8. API Gateway → MongoDB (создание/обновление пользователя)
   ↓
9. API Gateway → Генерация внутреннего JWT токена
   ↓
10. API Gateway → React Frontend (JWT токен)
```

---

## КОМПОНЕНТЫ БЕЗОПАСНОСТИ

### Прототип:
- JWT токены (автоматическое обновление)
- Верификация Telegram WebApp (initData)
- Хеширование PIN (bcryptjs, 12 раундов)
- Helmet (security headers)
- Rate limiting (100 запросов/15 мин)
- CORS (белый список)
- Валидация данных (express-validator/Pydantic)
- HTTPS
- Защита от XSS/CSRF

### Финальное решение:
- Все меры из прототипа +
- SSO (единый вход)
- OAuth2/OpenID Connect
- Биометрия для подтверждения операций
- Подтверждение крупных транзакций (>100 000 Р)
- Антифрод в реальном времени
- Блокчейн для прозрачности
- Соответствие СТО БР ФАПИ.СЕК-1.6-2020
- Соответствие ФЗ-152
- Данные хранятся и обрабатываются в РФ
- Обезличивание данных

---

## МАСШТАБИРОВАНИЕ

### Горизонтальное масштабирование:
- Stateless API (можно запускать несколько экземпляров)
- Load balancer перед API Gateway
- MongoDB репликация
- Кеширование (можно добавить Redis)

### Вертикальное масштабирование:
- Оптимизация запросов к БД
- Кеширование на уровне Redis
- CDN для статических файлов

---

## ДЕПЛОЙ

### Прототип:
- Frontend: Vercel или статический хостинг
- Backend: Docker контейнеры, PM2
- База данных: MongoDB (локально или облако)

### Финальное решение:
- Frontend: встраивается в приложение банка
- Backend: инфраструктура банка (Docker, Kubernetes)
- База данных: инфраструктура банка (MongoDB в РФ)

---

## ВИЗУАЛЬНАЯ СТРУКТУРА ДЛЯ СХЕМЫ

### Схема должна показать:

**Слева направо (или сверху вниз):**

1. **Пользователь**
   - Прототип: Telegram App
   - Финальное решение: Приложение банка (iOS/Android)

2. **Frontend Layer**
   - React Application (в WebView)
   - Компоненты, Pages, Stores, Services

3. **API Gateway Layer**
   - Node.js/Express или FastAPI
   - Middleware (Auth, Validation, Rate Limiting)

4. **Business Logic Layer**
   - BankingClient Service
   - Authentication Service

5. **Data Layer**
   - MongoDB Database
   - Коллекции: users, accounts, transactions

6. **External Integrations**
   - Open Banking APIs (VBank, ABank, SBank)
   - Telegram APIs (только прототип)
   - Внутренние API банка (только финальное решение)
   - OAuth Provider (только финальное решение)

### Цветовое кодирование (рекомендация):
- Синий: Frontend компоненты
- Зеленый: Backend компоненты
- Оранжевый: База данных
- Красный: Внешние API
- Фиолетовый: Безопасность
- Серый: Инфраструктура

### Связи:
- Сплошные линии: основные потоки данных
- Пунктирные линии: опциональные/условные связи
- Стрелки: направление потока данных

---

## КЛЮЧЕВЫЕ РАЗЛИЧИЯ ПРОТОТИП vs ФИНАЛЬНОЕ РЕШЕНИЕ

### Прототип:
- Контейнер: Telegram Mini App
- Аутентификация: Telegram WebApp (initData)
- Интеграции: только Open Banking API + Telegram API
- Идентификация: telegramId

### Финальное решение:
- Контейнер: Приложение банка (WebView)
- Аутентификация: OAuth2/OpenID Connect, SSO, биометрия
- Интеграции: Open Banking API + внутренние API банка
- Идентификация: bankUserId
- Дополнительно: нативные мосты, антифрод, блокчейн

---

## ТЕХНИЧЕСКИЕ ДЕТАЛИ ДЛЯ СХЕМЫ

### Порты:
- Frontend Dev: 5173 (Vite)
- Backend: 3001 (Express/FastAPI)
- MongoDB: 27017

### Протоколы:
- HTTPS (все внешние связи)
- REST API (между Frontend и Backend)
- Open Banking API (REST)

### Форматы данных:
- JSON (все API)
- JWT (токены)
- MongoDB BSON (база данных)

---

Это описание можно использовать для создания детальной схемы архитектуры системы.

